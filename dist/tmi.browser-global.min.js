"use strict";var tmi=(()=>{var M=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var O=(r,e)=>{for(var a in e)M(r,a,{get:e[a],enumerable:!0})},U=(r,e,a,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of B(e))!v.call(r,s)&&s!==a&&M(r,s,{get:()=>e[s],enumerable:!(t=N(e,s))||t.enumerable});return r};var A=r=>U(M({},"__esModule",{value:!0}),r);var Q={};O(Q,{Channel:()=>u,ChannelPlaceholder:()=>h,Client:()=>P,default:()=>Y,parseTag:()=>I});var L={s:" ",n:`
`,r:"\r",":":";","\\":"\\"},D={" ":"s","\n":"n","\r":"r",";":":","\\":"\\"};function G(r){return!r||!r.includes("\\")?r:r.replace(/\\[snr:\\]/g,e=>L[e[1]])}function w(r){return typeof r=="number"&&(r=r.toString()),r.replace(/[\s\n\r;\\]/g,e=>"\\"+D[e]||e)}function k(r,e){if(!r)return{raw:"",prefix:{},command:"",channel:"",params:[],rawTags:{},tags:{}};let a=0,t=()=>r.indexOf(" ",a),s=c=>{if(c===void 0){if(c=t(),c===-1){a=r.length;return}}else if(c===-1){a=r.length;return}a=c+1},n=(c,x=a)=>r[x]===c,i=r,g="";if(n("@")){let c=t();g=r.slice(1,c),s(c)}let l={};if(n(":")){let c=t(),x=r.slice(a+1,c);l=V(x),s(c)}let d=t(),o=r.slice(a,d===-1?void 0:d);s(d);let m="";if(n("#")){let c=t();c===-1?(m=r.slice(a),s()):(m=r.slice(a,c),s(c))}let p=[];for(;a<r.length;){if(n(":")){p.push(r.slice(a+1));break}let c=t();p.push(r.slice(a,c)),s(c)}let{rawTags:y,tags:T}=F(g,p,e);return{raw:i,rawTags:y,tags:T,prefix:l,command:o,channel:m,params:p}}function R(r){let{tags:e,prefix:a,command:t,channel:s,params:n}=r,i=(m,p=" ")=>m?`${p}${m}`:null,g=e?i(W(e),"@"):null,l=a?i(H(a),":"):null,d=s?K(s):null,o=n&&n.length?i(n.join(" "),":"):null;return[g,l,t,d,o].filter(Boolean).join(" ")}function _(r,e,a,t){let s=G(r),n=s,i=G(e),g=i;return t&&([n,g]=t(n,i,a??[])),{unescapedKey:s,unescapedValue:i,key:n,value:g}}function F(r,e,a){let t={},s={};return r?(r.split(";").forEach(n=>{let[i,g]=n.split("="),{unescapedKey:l,unescapedValue:d,key:o,value:m}=_(i,g,e,a);t[l]=d,s[o]=m}),{rawTags:t,tags:s}):{rawTags:t,tags:s}}function V(r){let e={};if(!r)return e;if(r.includes("!")){let[a,t]=r.split("!");e.nick=a,[e.user,e.host]=t.includes("@")?t.split("@"):[t,void 0]}else r.includes("@")?[e.user,e.host]=r.split("@"):e.host=r;return e}function W(r){return(Array.isArray(r)?r:Object.entries(r)).map(([a,t])=>`${w(a)}=${w(t.toString())}`).join(";")}function H(r){if(!r)return"";let{nick:e,user:a,host:t}=r;return e?`${e}${a?`!${a}`:""}${t?`@${t}`:""}`:""}function K(r){return r?`${r.startsWith("#")?r:`#${r}`}`:""}var f=class{listeners=new Map;on(e,a){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(a),this}off(e,a){return this.listeners.get(e)?.delete(a),this}emit(e,...a){if(!this.listeners.has(e)){if(e==="error")throw a[0]instanceof Error?a[0]:new Error("Uncaught error emitted",{cause:a[0]});return!1}for(let t of this.listeners.get(e))t(...a);return!0}};var b=class extends Map{toJSON(){return[...this.entries()]}};var $=/-(\w)/g;function j(r){return r.replace($,(e,a)=>a.toUpperCase())}function I(r,e,a){switch(r=j(r),r){case"banDuration":case"bits":case"msgParamBreakpointNumber":case"msgParamBreakpointThresholdBits":case"msgParamContributor1Taps":case"msgParamContributor2Taps":case"msgParamContributor3Taps":case"msgParamCopoReward":case"msgParamCumulativeMonths":case"msgParamGiftMatchBonusCount":case"msgParamGiftMatchExtraCount":case"msgParamGiftMonthBeingRedeemed":case"msgParamGiftMonths":case"msgParamGoalCurrentContributions":case"msgParamGoalTargetContributions":case"msgParamGoalUserContributions":case"msgParamLargestContributorCount":case"msgParamMassGiftCount":case"msgParamMonths":case"msgParamMsRemaining":case"msgParamMultimonthDuration":case"msgParamMultimonthTenure":case"msgParamSenderCount":case"msgParamStreakMonths":case"msgParamStreakSizeBits":case"msgParamStreakSizeTaps":case"msgParamThreshold":case"msgParamValue":case"msgParamViewerCount":case"sentTs":case"slow":case"tmiSentTs":return[r,parseInt(e,10)];case"msgParamAnonGift":case"msgParamPriorGifterAnonymous":case"msgParamWasGifted":return[r,e==="true"];case"emoteOnly":case"firstMsg":case"mod":case"msgParamShouldShareStreak":case"returningChatter":case"sourceOnly":case"subsOnly":case"subscriber":case"turbo":case"vip":return[r,e==="1"];case"r9k":return["unique",e==="1"];case"followersOnly":return[r,{enabled:e!=="-1",durationMinutes:parseInt(e,10)}];case"badgeInfo":case"badges":case"sourceBadgeInfo":case"sourceBadges":return e?[r,e.split(",").reduce((t,s)=>{let[n,i]=s.split("/");return t.set(n,i),t},new b)]:[r,new b];case"emotes":return e?[r,e.split("/").map(t=>{let[s,n]=t.split(":"),i=n.split(",").map(g=>{let[l,d]=g.split("-");return[Number(l),Number(d)+1]});return{id:s,indices:i}})]:[r,[]];case"emoteSets":return[r,e.split(",")];case"threadId":return[r,e.split("_")];case"flags":{let t=[];if(!e)return[r,t];let s=[...a[0]];for(let n of e.split(",")){let[i,g]=n.split(":"),[l,d]=i.split("-"),o=[Number(l),Number(d)+1],m=g.split("/");t.push({index:o,flags:m.reduce((p,[y,,T])=>(p[y]=Number(T),p),{}),text:s.slice(...o).join("")})}return[r,t]}case"animationId":case"clientNonce":case"color":case"customRewardId":case"displayName":case"id":case"login":case"messageId":case"msgId":case"msgParamCategory":case"msgParamChannelDisplayName":case"msgParamColor":case"msgParamCommunityGiftId":case"msgParamContributor1":case"msgParamContributor2":case"msgParamContributor3":case"msgParamDisplayName":case"msgParamFunString":case"msgParamGiftId":case"msgParamGiftMatch":case"msgParamGiftMatchGifterDisplayName":case"msgParamGiftTheme":case"msgParamGifterId":case"msgParamGifterLogin":case"msgParamGifterName":case"msgParamGoalContributionType":case"msgParamGoalDescription":case"msgParamId":case"msgParamLogin":case"msgParamOriginId":case"msgParamPriorGifterDisplayName":case"msgParamPriorGifterId":case"msgParamPriorGifterUserName":case"msgParamRecipientDisplayName":case"msgParamRecipientId":case"msgParamRecipientUserName":case"msgParamSenderLogin":case"msgParamSenderName":case"msgParamSubPlanName":case"msgParamSubPlan":case"msgParamViewerCustomizationId":case"replyParentDisplayName":case"replyParentMsgBody":case"replyParentMsgId":case"replyParentUserId":case"replyParentUserLogin":case"replyThreadParentDisplayName":case"replyThreadParentMsgId":case"replyThreadParentUserId":case"replyThreadParentUserLogin":case"roomId":case"sourceId":case"sourceMsgId":case"sourceRoomId":case"systemMsg":case"targetMsgId":case"targetUserId":case"userId":case"userType":return[r,e];case"msgParamProfileImageURL":return["msgParamProfileImageUrl",e]}return[r,e]}var C=class{name;id;token;isAnonymous(){return!this.token||typeof this.token=="string"&&this.token.trim()===""}setToken(e){this.token=e}async getToken(){if(typeof this.token=="string")return this.token;if(typeof this.token=="function")return await this.token();throw new Error("Invalid token")}[Symbol.for("nodejs.util.inspect.custom")](){let e=this.name?`"${this.name}"`:"undefined",a=this.id?`"${this.id}"`:this.id===""?'""':"undefined",t=this.token?typeof this.token=="string"?this.token===""?'""':"[hidden]":"[hidden function]":"undefined";return`Identity { name: ${e}, id: ${a}, token: ${t} }`}};var u=class r{constructor(e,a){this._id=e;this._login=a;this.id=e,this.login=a}static toLogin(e){let a=e.trim().toLowerCase();return a.startsWith("#")?a.slice(1):a}static toIrc(e){return e instanceof r?`#${e.login}`:`#${r.toLogin(e)}`}lastUserstate=null;set id(e){if(typeof e!="string")throw new TypeError("Channel#id must be a string");this._id=e}get id(){return this._id}set login(e){if(typeof e!="string")throw new TypeError("Channel#login must be a string");this._login=r.toLogin(e)}get login(){return this._login}toString(){return r.toIrc(this._login)}},h=class extends u{constructor(e,a){if(e===void 0&&a)e=`unknownId:login(${u.toLogin(a)})`;else if(a===void 0&&e)a=`unknownLogin:id(${e})`;else if(e===void 0&&a===void 0)throw new Error("ChannelPlaceholder must have either id or login");super(e,a)}};var J="ACTION ",q="",X="ananonymousgifter";function E(r){return{id:r.userId,display:r.displayName,color:r.color,badges:r.badges,badgeInfo:r.badgeInfo,isBroadcaster:r.badges.has("broadcaster"),isMod:r.mod,isSubscriber:r.subscriber,isFounder:r.badges.has("founder"),isVip:"vip"in r&&r.vip===!0,type:r.userType}}var P=class extends f{socket=void 0;keepalive={maxWaitTimeoutMs:15e3,pingIntervalSeconds:15,pingTimeoutSeconds:10,reconnectAttempts:0};channelsPendingJoin;channels=new Set;channelsById=new Map;channelsByLogin=new Map;identity=new C;wasCloseCalled=!1;constructor(e){super(),this.channelsPendingJoin=(e?.channels??[]).reduce((a,t)=>(a.add(u.toLogin(t)),a),new Set),e?.token&&this.identity.setToken(e.token)}connect(){if(this.isConnected())throw new Error("Client is already connected");this.wasCloseCalled=!1;let e=new WebSocket("wss://irc-ws.chat.twitch.tv:443");this.socket=e,e.onmessage=a=>this.onSocketMessage(a),e.onclose=a=>this.onSocketClose(a),e.onopen=a=>this.onSocketOpen(a),e.onerror=a=>this.onSocketError(a)}close(){this.wasCloseCalled=!0,this.isConnected()&&this.socket.close()}async reconnect(){this.isConnected()&&this.socket.close();let e=Math.min(1e3*1.23**this.keepalive.reconnectAttempts++,6e4);this.emit("reconnecting",{attempts:this.keepalive.reconnectAttempts,waitTime:e}),await new Promise(a=>setTimeout(a,e)),this.connect()}onSocketMessage(e){e.data.trim().split(`\r
`).forEach(a=>this.onIrcLine(a))}onSocketClose(e){clearInterval(this.keepalive.pingInterval),clearTimeout(this.keepalive.pingTimeout),this.wasCloseCalled||this.reconnect(),this.emit("close",{reason:e.reason,code:e.code,wasCloseCalled:this.wasCloseCalled})}async onSocketOpen(e){this.keepalive.reconnectAttempts=0;let a=this.identity.isAnonymous(),t=a?"schmoopiie":`oauth:${await this.identity.getToken()}`;this.sendIrc({command:"CAP REQ",params:["twitch.tv/commands","twitch.tv/tags"]}),this.sendIrc({command:"PASS",params:[t]}),this.sendIrc({command:"NICK",params:[a?"justinfan123456":"justinfan"]})}onSocketError(e){this.emit("socketError",e)}getChannelById(e){return this.channelsById.get(e)}getChannelByLogin(e){return this.channelsByLogin.get(u.toLogin(e))}getChannelPlaceholder(e,a){return new h(e,a)}onIrcLine(e){let a=k(e,I);a&&this.onIrcMessage(a)}onIrcMessage(e){switch(this.emit("ircMessage",e),e.command){case"PING":return this.handlePING(e);case"PONG":return this.handlePONG(e);case"PRIVMSG":return this.handlePRIVMSG(e);case"USERSTATE":return this.handleUSERSTATE(e);case"GLOBALUSERSTATE":return this.handleGLOBALUSERSTATE(e);case"USERNOTICE":return this.handleUSERNOTICE(e);case"NOTICE":return this.handleNOTICE(e);case"CLEARCHAT":return this.handleCLEARCHAT(e);case"CLEARMSG":return this.handleCLEARMSG(e);case"ROOMSTATE":return this.handleROOMSTATE(e);case"JOIN":return this.handleJOIN(e);case"PART":return this.handlePART(e);case"WHISPER":return this.handleWHISPER(e);case"RECONNECT":return this.handleRECONNECT(e);case"376":return this.handle376(e);case"CAP":case"001":case"002":case"003":case"004":case"353":case"366":case"375":case"372":break;default:break}}handlePING(e){this.keepalive.lastPingReceivedAt=Date.now(),this.sendIrc({command:"PONG",params:e.params})}handlePONG(e){if(clearTimeout(this.keepalive.pingTimeout),this.keepalive.lastPongReceivedAt=Date.now(),this.keepalive.lastPingSent===void 0)throw new Error("Received PONG without having sent a PING");this.keepalive.latencyMs=this.keepalive.lastPongReceivedAt-this.keepalive.lastPingSent,this.emit("pong")}handlePRIVMSG({tags:e,prefix:a,channel:t,params:s}){let n=this.getChannelById(e.roomId)??this.getChannelPlaceholder(e.roomId,t),i=s[0],g=i.startsWith(J)&&i.endsWith(q);g&&(i=i.slice(8,-1));let l,d,o,m;if("sourceRoomId"in e&&(l={channel:this.getChannelById(e.sourceRoomId)??this.getChannelPlaceholder(e.sourceRoomId,void 0),user:{badges:e.sourceBadges,badgeInfo:e.sourceBadgeInfo},message:{id:e.sourceId},sourceOnly:e.sourceOnly}),"bits"in e&&(d={bits:e.bits}),"replyParentMsgId"in e&&(o={id:e.replyParentMsgId,text:e.replyParentMsgBody,user:{id:e.replyParentUserId,login:e.replyParentUserLogin,display:e.replyParentDisplayName},thread:{id:e.replyThreadParentMsgId,user:{id:e.replyThreadParentUserId,login:e.replyThreadParentUserLogin,display:e.replyThreadParentDisplayName}}}),"customRewardId"in e)m={type:"custom",rewardId:e.customRewardId};else if("msgId"in e)switch(e.msgId){case"highlighted-message":{m={type:"highlighted"};break}case"skip-subs-mode-message":{m={type:"skipSubs"};break}case"gigantified-emote-message":{m={type:"gigantifiedEmote",get emoteId(){let p=e.emotes[0],y=p.indices[p.indices.length-1][1];for(let T=1;T<e.emotes.length;T++){let S=e.emotes[T],c=S.indices[S.indices.length-1][1];c>y&&(p=S,y=c)}return p.id}};break}case"animated-message":{m={type:"messageEffects",animation:e.animationId};break}default:{m={type:"unknown",msgId:e.msgId};break}}this.emit("message",{channel:n,user:{...E(e),login:a.nick,isTurbo:e.turbo,isReturningChatter:e.returningChatter},message:{id:e.id,text:i,flags:e.flags,emotes:e.emotes,isAction:g,isFirst:e.firstMsg},sharedChat:l,announcement:void 0,cheer:d,parent:o,reward:m,tags:e})}handleUSERSTATE({tags:e,channel:a}){let t=this.getChannelByLogin(a)??this.getChannelPlaceholder(void 0,a),s={id:this.identity.id,color:e.color,login:this.identity.name,display:e.displayName,badges:e.badges,badgeInfo:e.badgeInfo,isBroadcaster:e.badges.has("broadcaster"),isMod:e.mod,isSubscriber:e.subscriber,isFounder:e.badges.has("founder"),isTurbo:e.badges.has("turbo"),isVip:e.badges.has("vip"),type:e.userType};this.emit("userState",{channel:t,user:s})}handleGLOBALUSERSTATE({tags:e}){this.identity.id=e.userId,this.emit("globalUserState",{user:{id:e.userId,display:e.displayName,color:e.color,badges:e.badges,badgeInfo:e.badgeInfo,isTurbo:e.badges.has("turbo"),type:e.userType},emoteSets:e.emoteSets,tags:e})}handleUSERNOTICE({tags:e,channel:a,params:t}){let s=t[0],n=this.getChannelById(e.roomId)??this.getChannelPlaceholder(e.roomId,a),i={...E(e),login:e.login,isTurbo:"turbo"in e&&e.turbo===!0,isReturningChatter:"returningChatter"in e&&e.returningChatter===!0},g;"msgParamGoalContributionType"in e&&e.msgParamGoalContributionType&&(g={type:e.msgParamGoalContributionType,description:e.msgParamGoalDescription??"",current:e.msgParamGoalCurrentContributions,target:e.msgParamGoalTargetContributions,userContributions:e.msgParamGoalUserContributions});let l="Prime",d=o=>typeof o!="string"||o===l?1:parseInt(o.slice(0,1));switch(e.msgId){case"announcement":{this.emit("message",{channel:n,user:i,message:{id:e.id,text:s,flags:e.flags,emotes:e.emotes,isAction:!1,isFirst:"firstMsg"in e&&e.firstMsg===!0},sharedChat:void 0,announcement:{color:e.msgParamColor},cheer:void 0,parent:void 0,reward:void 0,tags:e});break}case"sub":{this.emit("sub",{type:"sub",channel:n,user:i,plan:{name:e.msgParamSubPlanName,plan:e.msgParamSubPlan,tier:d(e.msgParamSubPlan),isPrime:e.msgParamSubPlan===l},multiMonth:{duration:e.msgParamMultimonthDuration??0},goal:g,tags:e});break}case"resub":{let o,m;e.msgParamShouldShareStreak&&(o={months:e.msgParamStreakMonths}),e.msgParamWasGifted&&(m={monthBeingRedeemed:e.msgParamGiftMonthBeingRedeemed,months:e.msgParamGiftMonths,gifter:{isAnon:e.msgParamAnonGift,id:e.msgParamGifterId,login:e.msgParamGifterLogin,display:e.msgParamGifterName}}),this.emit("sub",{type:"resub",channel:n,user:i,cumulativeMonths:e.msgParamCumulativeMonths,multiMonth:{duration:e.msgParamMultimonthDuration??0,tenure:e.msgParamMultimonthTenure??0},streak:o,plan:{name:e.msgParamSubPlanName,plan:e.msgParamSubPlan,tier:d(e.msgParamSubPlan),isPrime:e.msgParamSubPlan===l},gift:m,tags:e});break}case"subgift":{let o;e.msgParamCommunityGiftId&&(o={id:e.msgParamCommunityGiftId}),this.emit("sub",{type:"subGift",channel:n,user:i,recipient:{id:e.msgParamRecipientId,login:e.msgParamRecipientUserName,display:e.msgParamRecipientDisplayName},plan:{name:e.msgParamSubPlanName,plan:e.msgParamSubPlan,tier:d(e.msgParamSubPlan),isPrime:e.msgParamSubPlan===l},gift:{months:e.msgParamGiftMonths,theme:e.msgParamGiftTheme,originId:e.msgParamOriginId},mystery:o,goal:g,tags:e});break}case"submysterygift":{let o;"msgParamGiftMatch"in e&&(o={type:e.msgParamGiftMatch,bonusCount:e.msgParamGiftMatchBonusCount,extraCount:e.msgParamGiftMatchExtraCount,originalGifter:e.msgParamGiftMatchGifterDisplayName}),this.emit("sub",{type:"subMysteryGift",channel:n,user:i,plan:{name:void 0,plan:e.msgParamSubPlan,tier:d(e.msgParamSubPlan),isPrime:!1},mystery:{id:e.msgParamCommunityGiftId,count:e.msgParamMassGiftCount,theme:e.msgParamGiftTheme,gifterLifetimeCount:e.msgParamSenderCount},giftMatch:o,goal:g,tags:e});break}case"standardpayforward":{this.emit("sub",{type:"standardPayForward",channel:n,user:i,recipient:{id:e.msgParamRecipientId,login:e.msgParamRecipientUserName,display:e.msgParamRecipientDisplayName},tags:e});break}case"communitypayforward":{this.emit("sub",{type:"communityPayForward",channel:n,user:i,priorGifter:{isAnon:e.msgParamPriorGifterAnonymous,id:e.msgParamPriorGifterId,login:e.msgParamPriorGifterUserName,display:e.msgParamPriorGifterDisplayName},tags:e});break}case"giftpaidupgrade":{this.emit("sub",{type:"giftPaidUpgrade",channel:n,user:i,gifter:{isAnon:e.msgParamSenderLogin===X,login:e.msgParamSenderLogin,display:e.msgParamSenderName},tags:e});break}case"primepaidupgrade":{this.emit("sub",{type:"primePaidUpgrade",channel:n,user:i,plan:{name:void 0,plan:e.msgParamSubPlan,tier:d(e.msgParamSubPlan),isPrime:!1},tags:e});break}case"onetapstreakstarted":{this.emit("combos",{type:"started",channel:n,timestamp:e.tmiSentTs,theme:e.msgParamGiftId,streak:{msRemaining:e.msgParamMsRemaining},tags:e});break}case"onetapstreakexpired":{let o=[],m=(p,y)=>{p&&y&&o.push({display:p,taps:y})};m(e.msgParamContributor1,e.msgParamContributor1Taps),m(e.msgParamContributor2,e.msgParamContributor2Taps),m(e.msgParamContributor3,e.msgParamContributor3Taps),this.emit("combos",{type:"expired",channel:n,timestamp:e.tmiSentTs,theme:e.msgParamGiftId,streak:{bits:e.msgParamStreakSizeBits,taps:e.msgParamStreakSizeTaps},topContributors:o,tags:e});break}case"onetapbreakpointachieved":{this.emit("combos",{type:"breakpointAchieved",channel:n,timestamp:e.tmiSentTs,theme:e.msgParamGiftId,threshold:{level:e.msgParamBreakpointNumber,bits:e.msgParamBreakpointThresholdBits},tags:e});break}case"raid":{this.emit("raid",{channel:n,user:{...E(e),login:e.msgParamLogin},viewers:e.msgParamViewerCount,tags:e});break}case"unraid":{this.emit("unraid",{channel:n,tags:e});break}case"bitsbadgetier":{this.emit("badgeUpgrade",{channel:n,user:i,type:"bits",threshold:e.msgParamThreshold,tags:e,message:{id:e.id,text:s,flags:e.flags,emotes:e.emotes,isAction:!1,isFirst:"firstMsg"in e&&e.firstMsg===!0}});break}case"viewermilestone":{this.emit("viewerMilestone",{channel:n,user:i,type:e.msgParamCategory,milestone:{id:e.msgParamId,value:e.msgParamValue,reward:e.msgParamCopoReward},tags:e});break}case"sharedchatnotice":{let m={channel:this.getChannelById(e.sourceRoomId)??this.getChannelPlaceholder(e.sourceRoomId,void 0),user:{badges:e.sourceBadges,badgeInfo:e.sourceBadgeInfo},message:{id:e.sourceId},sourceOnly:e.sourceOnly??!1};this.emit("sharedChatNotice",{type:e.sourceMsgId,channel:n,sharedChat:m,timestamp:e.tmiSentTs,tags:e});break}}}handleNOTICE({channel:e,tags:a,params:t}){let{msgId:s}=a;if(!s){let i=t[1];switch(this.close(),i){case"Login authentication failed":break;case"Improperly formatted auth":let g=new Error(`Catatrophic error: ${i}`);this.emit("error",g)}return}let n=this.getChannelByLogin(e)??this.getChannelPlaceholder(void 0,e);switch(s){case"emote_only_on":case"emote_only_off":case"followers_on_zero":case"followers_on":case"followers_off":case"r9k_on":case"r9k_off":case"slow_on":case"slow_off":case"subs_on":case"subs_off":break;case"msg_channel_suspended":case"msg_duplicate":case"msg_timedout":case"unrecognized_cmd":this.emit("messageDropped",{channel:n,reason:s,systemMessage:t[0]??"",tags:a});break}}handleCLEARCHAT({channel:e,tags:a,params:t}){let s=this.getChannelById(a.roomId)??this.getChannelPlaceholder(a.roomId,e),n=a.tmiSentTs;"banDuration"in a?this.emit("moderation",{type:"timeout",channel:s,duration:a.banDuration,user:{id:a.targetUserId,login:t[0]},timestamp:n,tags:a}):"targetUserId"in a?this.emit("moderation",{type:"ban",channel:s,user:{id:a.targetUserId,login:t[0]},timestamp:n,tags:a}):this.emit("moderation",{type:"clearChat",channel:s,timestamp:n,tags:a})}handleCLEARMSG({tags:e,channel:a,params:t}){let s=this.getChannelById(e.roomId)??this.getChannelPlaceholder(e.roomId,a);this.emit("moderation",{type:"deleteMessage",channel:s,user:{login:e.login},message:{id:e.targetMsgId,text:t[0]},timestamp:e.tmiSentTs,tags:e})}handleROOMSTATE({tags:e,channel:a}){let t=this.getChannelById(e.roomId);t||(t=new u(e.roomId,a),this.channels.add(t),this.channelsById.set(e.roomId,t),this.channelsByLogin.set(a,t)),this.emit("roomState",{channel:t,emoteOnly:e.emoteOnly,followersOnly:e.followersOnly,unique:e.unique,slow:e.slow,subsOnly:e.subsOnly,tags:e})}handleJOIN(e){}handlePART({channel:e}){let a=this.getChannelByLogin(e)??this.getChannelPlaceholder(void 0,e);this.emit("part",{channel:a})}handleWHISPER({tags:e,prefix:a,params:t}){let s=t[1],n=s.startsWith("/me ");n&&(s=s.slice(4)),this.emit("whisper",{user:{id:e.userId,login:a.nick,display:e.displayName,color:e.color,badges:e.badges,isTurbo:e.turbo,type:e.userType},thread:{id:e.threadId},message:{id:e.messageId,text:s,emotes:e.emotes,isAction:n}})}handleRECONNECT(e){this.reconnect()}handle376(e){this.identity.name=e.params[0],this.emit("connect"),this.joinPendingChannels()}isConnected(){return!!this.socket&&this.socket.readyState===WebSocket.OPEN}send(e){if(!this.isConnected())throw new Error("Not connected");this.socket.send(e)}sendIrc(e){let a=R({...e,channel:e.channel?.toString()});if(!a)throw new Error("Result message is empty");this.send(a)}async join(e){let a=typeof e=="string"?u.toIrc(e):e.toString(),t=this.waitForCommand(this.identity.isAnonymous()?"JOIN":"USERSTATE",s=>s.channel===a&&(s.prefix.nick?s.prefix.nick===this.identity.name:!0),{channelHint:u.toIrc(e)});this.sendIrc({command:"JOIN",channel:a}),await t}async part(e){let a=typeof e=="string"?u.toIrc(e):e.toString(),t=this.waitForCommand("PART",s=>s.channel===a&&s.prefix.nick===this.identity.name,{channelHint:u.toIrc(e)});this.sendIrc({command:"PART",channel:a}),await t}async say(e,a,t={}){if(a.length===0)throw new Error("Message cannot be empty");if(a.length>500)throw new Error("Message is too long (max 500 characters)");let s={"client-nonce":this.generateClientNonce(),...t},n=s["client-nonce"],i=this.waitForCommand("USERSTATE",g=>g.tags.clientNonce===n,{channelHint:u.toIrc(e)});return this.sendIrc({command:"PRIVMSG",channel:e,params:[a],tags:s}),await i}async reply(e,a,t,s={}){return this.say(e,a,{"reply-parent-msg-id":t,...s})}generateClientNonce(){return`tmi.js-${globalThis.crypto?.randomUUID?.()??Math.random().toString(16).slice(2)}`}ping(){this.keepalive.lastPingSent=Date.now(),this.sendIrc({command:"PING"}),this.keepalive.pingTimeout=setTimeout(()=>this.reconnect(),this.keepalive.pingTimeoutSeconds*1e3)}async joinPendingChannels(){for(let e of this.channelsPendingJoin)try{await this.join(e)}catch(a){let t=new Error("Failed to join channel",{cause:a});this.emit("error",t)}}waitForCommand(e,a,t){return new Promise((s,n)=>{let i=t?.failOnDrop??!0,g=t?.timeoutMs??Math.max(1e3,Math.min(this.keepalive.maxWaitTimeoutMs,(this.keepalive.latencyMs??500)*2)),l=p=>{p.command===e&&(!a||a(p))&&(o(),clearTimeout(m),s(p))},d=p=>{t?.channelHint&&p.channel.toString()!==t?.channelHint||(o(),n(new Error(`Message dropped: ${p.reason}`,{cause:p})))},o=()=>{this.off("ircMessage",l),i&&this.off("messageDropped",d)},m=setTimeout(()=>{o();let p=new Error(`Did not receive command in time (Command: ${e}, Waited: ${g}ms)`,{cause:e});n(p)},g);m.unref?.(),this.on("ircMessage",l),i&&this.on("messageDropped",d)})}};var Y={Client:P,parseTag:I};return A(Q);})();
//# sourceMappingURL=tmi.browser-global.min.js.map
